name: Analyze and Generate Annotations

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      # Checkout del repositorio
      - name: Checkout repository
        uses: actions/checkout@v3

      # Configurar Java 17
      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Verificar configuración de Java
      - name: Verify Java Configuration
        run: |
          java -version
          echo "JAVA_HOME is set to: $JAVA_HOME"

      # Configurar Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      # Instalar dependencias necesarias
      - name: Install Dependencies
        run: |
          python -m pip install pytest pytest-cov

      # Descargar e instalar SonarScanner
      - name: Install SonarScanner
        run: |
          echo "Downloading SonarScanner..."
          wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.7.0.2747-linux.zip
          echo "Extracting SonarScanner..."
          unzip sonar-scanner-cli-4.7.0.2747-linux.zip
          mv sonar-scanner-4.7.0.2747-linux sonar-scanner
          echo "Forcing SonarScanner to use Java 17..."
          sed -i "1s|^|export JAVA_HOME=$JAVA_HOME\nexport PATH=\$JAVA_HOME/bin:\$PATH\n|" sonar-scanner/bin/sonar-scanner
          echo "$(pwd)/sonar-scanner/bin" >> $GITHUB_PATH

      # Verificar instalación de SonarScanner
      - name: Verify SonarScanner Installation
        run: sonar-scanner --version

      # Ejecutar análisis de SonarCloud
      - name: SonarCloud Analysis
        env:
          JAVA_HOME: $JAVA_HOME
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.python.coverage.reportPaths=coverage-reports/coverage.xml \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}
